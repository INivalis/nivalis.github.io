<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0b1117" />
  <title>Comienzo~</title>
  <style>
    /* Bot√≥n de audio */
/* Boton version oscura y discreta */
.audio-fab{
  position: fixed;
  top: calc(env(safe-area-inset-top, 0px) + 10px);
  right: calc(env(safe-area-inset-right, 0px) + 10px);
  z-index: 10001;

  /* tama√±o compacto: texto ON/OFF cabe sin ‚Äúgritar‚Äù */
  width: 42px; height: 42px; border-radius: 9999px;

  /* fondo m√°s oscuro */
  background: rgba(8,14,20,0.58);
  backdrop-filter: blur(6px) saturate(105%) brightness(85%);

  /* l√≠neas  */
  border: 1px solid rgba(210,230,255,0.08);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.03),
    0 0px 0px rgba(0,0,0,0.28);

  display:flex; align-items:center; justify-content:center;
  color:#e7eef9; cursor:pointer;
  user-select:none; -webkit-tap-highlight-color: transparent;
  transition: background .2s ease, border-color .2s ease, box-shadow .2s ease, transform .06s ease;
}
.audio-fab:active{ transform: scale(0.985); }

/* Estado activo: relieve, sobrio */
.audio-fab.is-active{
  background: rgba(10,18,26,0.66);
  border-color: rgba(210,230,255,0.12);
  box-shadow:
    inset 0 0 0 1px rgba(255,255,255,0.05),
    0 0px 0px rgba(0,0,0,0.32);
}

/* Texto del bot√≥n (letras en lugar de icono) */
.audio-fab .label{
  font-family: inherit;
  font-weight: 600;
  font-size: 11.5px;
  letter-spacing: .08em;
  line-height: 1;
  opacity: .92;
  text-transform: uppercase;
}


    :root{
      --bg:#0b1117;
      --line-gap: 6px;
      --side-pad: 20px;
      --safe-w: calc(100vw - var(--side-pad) - var(--side-pad) - env(safe-area-inset-left) - env(safe-area-inset-right));
      /* Velocidad del temblor: menor = m√°s r√°pido, mayor = m√°s lento */
      --shake-speed: 0.05s;
    }
    *,*::before,*::after{ box-sizing: border-box; }
    html, body { height: 100%; margin:0; overflow:hidden; }
    html{ background: var(--bg); overscroll-behavior: none; }
    body { background:var(--bg); color:#e6f0ff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }

    .fade-black{ position:fixed; inset:0; background:var(--bg); opacity:0; pointer-events:none; z-index:9998; transition: opacity 1.5s ease; }
    .fade-black.prefade{ opacity:1; transition:none; }

    .top-phrases { position: fixed; top: 13vh; left: 50%; transform: translateX(-50%); width: min(820px, var(--safe-w)); text-align: center; color: #e8edf7; text-shadow: 0 1px 0 rgba(255,255,255,0.05); font-family: Georgia, "Times New Roman", serif; contain: layout paint; }
    .top-phrases .line{ overflow-wrap:anywhere; white-space: normal; display:block; font-size: clamp(20px, 3.2vw, 32px); opacity:.95; line-height:1.4; min-height: 1lh; padding-bottom: 0; }
    .top-phrases #l1{ margin-bottom: var(--line-gap); }
    .tap-hint { font-size: 12px; opacity:.75; margin-top: 12px; position: relative; pointer-events:none; transform: translateZ(0); will-change: transform; }

    .ghost-container { position: fixed; left: 50%; top: 54%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; gap: 0px; }
    .ghost-layer { position: relative; z-index: 2; pointer-events: none; }
    .ui-layer { position: relative; z-index: 3; margin-top: -40px; }

    #stage { width: 320px; height: 320px; }

    .gate { width: min(300px, var(--safe-w)); max-width: var(--safe-w); display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .ibox { width:100%; padding:12px; border-radius:12px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.14); box-shadow: 0 6px 18px rgba(0,0,0,.28); transition: opacity .2s ease; }
    .ibox.disabled { opacity:.55; filter:saturate(.7); }
    .field{ width:100%; padding:8px 10px; border-radius:10px; background: rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.10); box-shadow: inset 0 2px 8px rgba(0,0,0,0.25); }
    input[type="text"]{ width:100%; padding:10px 8px; border-radius:10px; border:0; outline:none; background:transparent; color:#e6f0ff; font-size:15px; }
    input[disabled]{ opacity:.7; }
    .btn-enter{ padding:6px 12px; font-size:13px; background:transparent; color:#e6f0ff; border:1px solid rgba(255,255,255,0.28); border-radius:10px; }
    .btn-enter:disabled{ opacity:.5; }
    .hint{ font-size:12px; opacity:.65; min-height:1lh; text-align:center; }
    .error{ color:#ff98a0; font-size:13px; min-height:1lh; text-align:center; }

    /* Temblor (2s por activaci√≥n) + wrapper anti-scroll */
    @keyframes shake { 0%,100%{ transform: translate(0,0);} 20%{ transform: translate(-2px,1px);} 40%{ transform: translate(2px,-1px);} 60%{ transform: translate(-2px,-1px);} 80%{ transform: translate(2px,1px);} }
    .shaker { position: fixed; inset: 0; overflow: hidden; width: 100vw; height: 100vh; }
    .shaker.shake { animation: shake var(--shake-speed) linear infinite; }

    /* Pantalla inicio para habilitar audio */
    .start { position: fixed; inset: 0; z-index: 10000; background: var(--bg); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:14px; cursor:pointer; user-select:none; text-align:center; }
    .start .touch-label{ font-size: clamp(12px, 3.2vw, 18px); letter-spacing:.02em; opacity:.75; padding:0; border:0; border-radius:0; background:transparent; box-shadow:none; pointer-events:none; text-shadow: 0 1px 0 rgba(255,255,255,0.05); animation: breathe 1.8s ease-in-out infinite; }
    @keyframes breathe { 0%{opacity:.6; transform:translateY(0)} 50%{opacity:1; transform:translateY(-2px)} 100%{opacity:.6; transform:translateY(0)} }
  
/* === Paso 5: Input y placeholder centrados === */
#pwd{ text-align:center; }
#pwd::placeholder{ text-align:center; opacity:.7; }
#pwd::-webkit-input-placeholder{ text-align:center; opacity:.7; }
#pwd::-moz-placeholder{ text-align:center; opacity:.7; }
#pwd:-ms-input-placeholder{ text-align:center; opacity:.7; }
#pwd::-ms-input-placeholder{ text-align:center; opacity:.7; }

/* === Brazo golpea input: efecto sutil en la caja === */
@keyframes ibox-bump { 
  0% { transform: translateY(0); } 
  35% { transform: translateY(2px); } 
  100% { transform: translateY(0); } 
}
#ibox.hit .field{
  box-shadow: inset 0 3px 10px rgba(0,0,0,0.35), 0 0 0 2px rgba(230,240,255,0.15);
  animation: ibox-bump 280ms ease-out;
}

/* === Golpe fuerte (enojo): borde un poco m√°s marcado === */
#ibox.hit-strong .field{
  box-shadow: inset 0 4px 12px rgba(0,0,0,0.45), 0 0 0 2px rgba(230,240,255,0.22);
}
</style>
  <script src="libs/pixi.min.js"></script>
  <script src="libs/live2dcubismcore.min.js"></script>
  <script src="libs/cubism4.min.js"></script>
  <script src="libs/index.min.js"></script>
</head>
<body>
  <div id="shaker" class="shaker">
  <div id="fade-black" class="fade-black prefade"></div>

  <!-- M√∫sica de fondo y viento en loop -->
  <audio id="bg" preload="auto" loop playsinline>
    <source src="goteo.mp3" type="audio/mpeg" />
  </audio>
  <audio id="bg2" preload="auto" loop playsinline>
    <source src="viento.mp3" type="audio/mpeg" />
  </audio>

  <!-- Overlay de inicio -->
  <div id="startOverlay" class="start" role="button" aria-label="Awaken Dream..." tabindex="0">
    <div class="touch-label">Awaken Dream...</div>
  </div>

<button id="audioFab" class="audio-fab" aria-label="Activar viento y goteo">
  <span id="audioFabIcon">üîá</span>
</button>

  <div class="top-phrases" id="phr">
    <div class="line" id="l1"></div>
    <div class="line" id="l2"></div>
    <div class="tap-hint">Healing Station~</div>
  </div>
 
  <div class="ghost-container">
    <div class="ghost-layer"><div id="stage"></div></div>
    <div class="ui-layer">
      <div class="gate">
        <div class="ibox disabled" id="ibox">
          <div class="field">
            <input id="pwd" type="text" placeholder="..." autocomplete="off" disabled />
          </div>
        </div>
        <button class="btn-enter" id="ok" disabled>Whisper Key</button>
        <div class="hint" id="hint">Listen First‚Ä¶</div>
        <div class="error" id="err"></div>
      </div>
    </div>
  </div>

  <script>
  (async function(){
    const FADE_IN_HOLD_MS=600, FADE_IN_DURATION_MS=1800, PHRASE_START_DELAY_MS=400, FADE_OUT_DURATION_MS=2200, WAIT_BEFORE_FADE_MS=1000;
    const TYPE_DELAY=28;

    const MOUTH_PARAM='ParamMouthOpen', EYE_PARAM='ParamEye', EXP_PARAM='ParamExpression', B1_PARAM='ParamBounce1', B2_PARAM='ParamBounce2';
    const BR_PARAM='ParamBreath';
    const clamp=(v,min,max)=>Math.max(min,Math.min(max,v));
    const BLINK_MIN_S=1.5, BLINK_MAX_S=4.0, BLINK_DURATION_MS=140;

    const phases=[
      { phrases:['This is not for you\n‚ô™‚Å†ÔΩû‚Å†(‚Å†¬¥‚Å†Œµ‚Å†ÔΩÄ‚Å†¬†‚Å†)', 'Don‚Äôt be too curious...\nÔΩ°‚Å†‚óï‚Å†‚Äø‚Å†‚óï‚Å†ÔΩ°', 'Remember to put this under the necklace\n(‚Å†¬†‚Å†‚óú‚Å†‚Äø‚Å†‚óù‚Å†¬†‚Å†)‚Å†‚ô°', 'I ll update it later...\nÔºº‚Å†(‚Å†¬∞‚Å†o‚Å†¬∞‚Å†)‚Å†Ôºè', 'Let me know before you deliver it\n(‚Å†‚ó†‚Å†‚Äø‚Å†‚óï‚Å†)'], password:'fuerapelado', error:['No no no...\njsjsjs...','hurts...\nTry again.'] },
      { phrases:['Entonces me escuchaste...\nQuiero creer en ti.','Me acerco un poco...\n¬øDir√°s mi verdadero nombre?'], password:'nivalis', error:['No, no es as√≠...\nMe confundes.','¬øPor qu√© dudas?\nPrueba otra vez.'] },
      { phrases:['√öltima prueba...\nLo dices siempre igual.','Resp√≥ndeme...\nY se abrir√° la puerta.'], password:'venus', error:['Ese no es...\nSolo hay un nombre final.','Intenta de nuevo...\nYa casi...'] }
    ];

    let currentPhase=0, iphr=0, ready=false, canAnswer=false, allowTap=true, flowStarted=false;
    // === Paso 1: Frases de enojo aleatorias ===
    let lastErrIndex = -1;
    const DEFAULT_ERROR_LINES = [
      "¬°No!\nEse no es.",
      "¬øOtra vez?\nConc√©ntrate.",
      "Grrr...\nEsa clave no.",
      "Hey.\nEst√°s cerca pero no.",
      "¬°Ay, Nivalis!\nEso duele.",
      "Hmm...\nIntenta con el verdadero nombre.",
      "No me provoques.\nPrueba de nuevo.",
      "Tsk tsk...\nA√∫n no es.",
      "Eres terco, ¬øeh?\nVuelve a intentar.",
      "Casi.\nPero no es esa."
    ];


    const app=new PIXI.Application({width:320,height:320,backgroundAlpha:0,antialias:true});
    document.getElementById('stage').appendChild(app.view);
    let model; try{model=await PIXI.live2d.Live2DModel.from('assets/ghost/ghost.model3.json');app.stage.addChild(model);}catch(e){alert('No se pudo cargar el modelo');return;}

    const core=()=>model.internalModel.coreModel;
    const setParam=(id,v)=>{try{core().setParameterValueById(id,v);}catch(_){}};

    function playSfx(src){ const a=new Audio(src); a.volume=0.9; a.play().catch(()=>{}); }
    function triggerAngry(){
      try{
      const now = performance.now();
      window.__angryUntil = now + 2200; // ~2.2s de enojo fuerte (match shake/duck)
      if (!window.__nextHitAt || window.__nextHitAt > now + 700) {
        window.__nextHitAt = now + (200 + Math.random()*500); // primer golpe r√°pido al enojarse
      }
    }catch(_){} 
    boostArms(2000, 1.8);
      setParam(EXP_PARAM,30); 
      // === Respiraci√≥n (ParamBreath) ===
      if (typeof window.__breathBase === 'undefined') { window.__breathBase = 0; }
      const isAngry = ((performance.now()) < window.__angryUntil) || window.__angryMode;
      const hasFocusCalm = (typeof window.__armCalm !== 'undefined') ? window.__armCalm : 1.0;
      const sec2 = performance.now()/1000;
      const breathRate = isAngry ? 0.22 : (hasFocusCalm < 0.8 ? 0.08 : 0.11); // Hz
      const breathAmp  = isAngry ? 9.0  : (hasFocusCalm < 0.8 ? 6.0  : 8.0);  // unidades ParamBreath
      const breath = Math.sin(2*Math.PI*breathRate*sec2) * breathAmp;
      try{ setParam(BR_PARAM, breath); }catch(_){}
setParam(B1_PARAM,15); setParam(B2_PARAM,-15);
      playSfx('rafaga.mp3');
      duckBgAll(2000, 0.12);
      shaker.classList.add('shake');
      if (shakeTO) clearTimeout(shakeTO);
      shakeTO = setTimeout(()=>{ shaker.classList.remove('shake'); }, 2000);
    }
    
function triggerHappyFinal(){
      // Paso 4: peque√±o delay y transici√≥n corta a feliz
      const TARGET = -30;           // expresi√≥n feliz
      const HOLD_MS = 320;          // peque√±o delay antes de sonre√≠r
      const TWEEN_MS = 260;         // transici√≥n corta
      // sonido y duck desde ya
      playSfx('bell.mp3');
      duckBgAll(WAIT_BEFORE_FADE_MS + FADE_OUT_DURATION_MS + 200, 0.12);

      // tween suave usando requestAnimationFrame
      setTimeout(()=>{
        const t0 = performance.now();
        // partimos desde neutro (0) como referencia visual
        const from = 0, to = TARGET;
        function step(t){
          const p = Math.min(1, (t - t0) / TWEEN_MS);
          // easeOutQuad
          const e = 1 - (1 - p) * (1 - p);
          const v = from + (to - from) * e;
          setParam(EXP_PARAM, v);
          if (p < 1) requestAnimationFrame(step);
        }
        requestAnimationFrame(step);
      }, HOLD_MS);
    }

    function resetNeutral(){ setParam(EXP_PARAM,0); setParam(B1_PARAM,0); setParam(B2_PARAM,0); }

    const setEye=(v)=>setParam(EYE_PARAM,v);
    function blinkOnce(){const start=performance.now(),dur=BLINK_DURATION_MS;setEye(1.0);(function frame(){const p=Math.min(1,(performance.now()-start)/dur);const v=1-4*p*(1-p);setEye(v);(p<1?requestAnimationFrame(frame):(setEye(1.0),setTimeout(blinkOnce,(BLINK_MIN_S+Math.random()*(BLINK_MAX_S-BLINK_MIN_S))*1000)));})();}

    function fit(){const w=app.renderer.width,h=app.renderer.height;const targetH=h*0.78;const s=targetH/model.height;model.scale.set(s);model.x=(w-model.width*s)*0.21;model.y=(h*0.5-model.height*s-86);} fit();

    
    // === Movimiento constante de brazos (ParamBounce1/2) ‚Äî igual que "index mejor version" ===
    // Variables de control
    let armAmp = 28;       // amplitud base
    let armFreq = 1.15;    // Hz (oscilaciones por segundo)
    let armBoost = 1.0;    // multiplicador temporal (enojo/final)
    let armAdd1 = 6, armAdd2 = -6; // offsets por si luego los usamos
    let armBoostTO = null;
    function boostArms(ms=2000, boost=1.8){
      armBoost = boost;
      if (armBoostTO) clearTimeout(armBoostTO);
      armBoostTO = setTimeout(()=> armBoost = 1.0, ms);
    }

    // Bucle continuo que alimenta ParamBounce1/2 con oscilaci√≥n suave y fase invertida
    app.ticker.add(()=>{
      const t = performance.now();
      const sec = t/1000;

      // --- Par√°metros del movimiento "natural"
      // Objetivos aleatorios que cambian cada ~1.8‚Äì2.6 s (random walk)
      if (!window.__armsInit) {
        window.__armsInit = true;
        window.__armBase1 = 0; window.__armBase2 = 0;
        window.__armTarget1 = 0; window.__armTarget2 = 0;
        window.__nextTargetAt = 0;
        window.__armCalm = 1.0;
        window.__hitActive = false;
        window.__hitDownEnd = 0;
        window.__hitEnd = 0;
        window.__nextHitAt = t + 3000 + Math.random()*3000; // primer golpe entre 3‚Äì6s
        window.__angryUntil = 0;
        window.__angryMode = false;
        window.__hitArm = 1; window.__lastHitArm = 2;
      }

      // Calma al escribir (si existe #pwd)
      // Nota: mantenemos compatibilidad con parches anteriores
      if (!window.__armCalmHandlers) {
        window.__armCalmHandlers = true;
        document.addEventListener('focusin', (e)=>{ if(e && e.target && e.target.id==='pwd') window.__armCalm = 0.45; }, true);
        document.addEventListener('focusout',(e)=>{ if(e && e.target && e.target.id==='pwd') window.__armCalm = 1.0;  }, true);
      }

      // Programar nuevos objetivos (random walk lento)
      if (t >= window.__nextTargetAt) {
        // rango base m√°s contenido; offsets armAdd1/2 se suman abajo
        window.__armTarget1 = (Math.random()*2-1) * 16;
        window.__armTarget2 = (Math.random()*2-1) * 16;
        const span = 1800 + Math.random()*800; // 1.8s .. 2.6s
        window.__nextTargetAt = t + span;
      }
      // acercar bases hacia objetivos (suavizado dependiente de calma)
      const follow = 0.06 * window.__armCalm; // menor = m√°s suave
      window.__armBase1 += (window.__armTarget1 - window.__armBase1) * follow;
      window.__armBase2 += (window.__armTarget2 - window.__armBase2) * follow;

      // Micro-oscilaciones (sutiles y desfasadas) para evitar sensaci√≥n de serrucho
      const micro1 = Math.sin(2*Math.PI*0.38*sec) * 2.2 + Math.sin(2*Math.PI*0.23*sec + 1.2) * 1.4;
      const micro2 = Math.sin(2*Math.PI*0.33*sec + 0.7) * 2.0 + Math.sin(2*Math.PI*0.19*sec + 2.1) * 1.2;

      // Amplitud final con respiraci√≥n lenta + calm & boost
      const breath = 1.0 + 0.16 * Math.sin(2*Math.PI*0.08*sec);
      const ampMul = breath * window.__armCalm * armBoost;

      // Valor base (antes de golpes)
      let b1 = (window.__armBase1 + micro1 + armAdd1) * ampMul;
      let b2 = (window.__armBase2 + micro2 + armAdd2) * ampMul;

      // --- Golpe aleatorio al input
      // Cuando toca, empuja ambos brazos hacia ~-28 con un peque√±o "impulso" y regresa
      if (!window.__hitActive && t >= window.__nextHitAt) {
        window.__hitActive = true;
        
        // Elegir qu√© brazo golpea: alternar, evitando repetir
        (function(){
          const prev = window.__lastHitArm || 2;
          // 70% prob. el otro brazo, 30% igual (por si quieres rachas)
          const other = (prev === 1 ? 2 : 1);
          window.__hitArm = (Math.random() < 0.70) ? other : prev;
          window.__lastHitArm = window.__hitArm;
        })();
        const down = 130 + Math.random()*80;  // 130‚Äì210ms bajar
        const up = 240 + Math.random()*160;   // 240‚Äì400ms subir
        window.__hitDownEnd = t + down;
        window.__hitEnd = window.__hitDownEnd + up;
        // Cadencia depende del enojo: muy seguido si est√° enojado
        {
          const angry = (t < window.__angryUntil) || window.__angryMode;
          const minMs = angry ? 280 : 3500;
          const maxMs = angry ? 520 : 8500;
          window.__nextHitAt = t + minMs + Math.random() * (maxMs - minMs);
        } // pr√≥ximo golpe programado
        // efecto visual en la caja
        try {
          const ibox = document.getElementById('ibox');
          if (ibox) { ibox.classList.add('hit'); setTimeout(()=>ibox.classList.remove('hit'), up+down); }
        } catch(_){}
      }

      if (window.__hitActive) {
        const hitTarget = (t < window.__angryUntil ? -30 : -28); // hacia abajo, simulando tocar la barra
        if (t <= window.__hitDownEnd) {
          // Ease-out r√°pido hacia el objetivo
          const p = 1 - Math.max(0, (window.__hitDownEnd - t) / (window.__hitDownEnd - (window.__hitDownEnd - (window.__hitDownEnd - t))));
          const e = 1 - (1-p)*(1-p); // easeOutQuad
          if (window.__hitArm === 1) { b1 = b1 + (hitTarget - b1) * e; }
           else { b2 = b2 + (hitTarget - b2) * e; }
        } else if (t <= window.__hitEnd) {
          // Regreso suave al valor base
          const p = 1 - Math.max(0, (window.__hitEnd - t) / (window.__hitEnd - window.__hitDownEnd));
          const e = p*p*(3-2*p); // smoothstep
          // Interpolar desde el punto del golpe (cerca de hitTarget) al valor base calculado al vuelo
          if (window.__hitArm === 1) { b1 = hitTarget + (b1 - hitTarget) * e; }
           else { b2 = hitTarget + (b2 - hitTarget) * e; }
        } else {
          window.__hitActive = false;
        }
      }

      setParam(B1_PARAM, clamp(b1, -30, 30));
      setParam(B2_PARAM, clamp(b2, -30, 30));
    });


    setParam(MOUTH_PARAM,0);setEye(1.0);blinkOnce();resetNeutral();

    const $l1=document.getElementById('l1'),$l2=document.getElementById('l2');
    const $pwd=document.getElementById('pwd'),$ok=document.getElementById('ok'),$err=document.getElementById('err');
    const $ibox=document.getElementById('ibox'),$hint=document.getElementById('hint');
    const fb=document.getElementById('fade-black');
    const shaker=document.getElementById('shaker');
    let shakeTO = null;

    // === Audios de fondo ===
    const bg = document.getElementById('bg');
    const bg2 = document.getElementById('bg2');
    let bgStarted=false; 
    function playLoop(el, vol){ if(!el) return Promise.resolve(); el.volume=vol; el.preload='auto'; const p=el.play(); return p&&p.then?p.catch(()=>{}):Promise.resolve(); }
    function startAudio(){ if(bgStarted) return; bgStarted=true; return Promise.all([playLoop(bg, 0.25), playLoop(bg2, 0.08)]); }
    function duckBgAll(ms=2000, to=0.12){ const v1=bg?bg.volume:0, v2=bg2?bg2.volume:0; if(bg) bg.volume=Math.min(v1,to); if(bg2) bg2.volume=Math.min(v2,to*0.8); setTimeout(()=>{ if(bg) bg.volume=v1; if(bg2) bg2.volume=v2; }, ms); }

    // === Inicio manual para habilitar audio y flujo ===
    const startOverlay=document.getElementById('startOverlay');
    function startFlow(){ if(flowStarted) return; flowStarted=true; setTimeout(()=>{ fb.classList.remove('prefade'); fb.style.transition=`opacity ${FADE_IN_DURATION_MS}ms ease-in-out`; fb.style.opacity=0; setTimeout(()=>{ ready=true; showPhrases(); }, FADE_IN_DURATION_MS + PHRASE_START_DELAY_MS); }, FADE_IN_HOLD_MS); }
    async function startAll(){ try{ await startAudio(); }catch(_){} startOverlay.remove(); startFlow(); }
    startOverlay.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startAll(); }, { once:true });
    startOverlay.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); startAll(); } });
// === Bot√≥n extra para activar/silenciar viento + goteo (versi√≥n letras) ===
const audioFab = document.createElement('button');
audioFab.className = 'audio-fab';
audioFab.id = 'audioFab';
audioFab.setAttribute('aria-label', 'Activar viento y goteo');

const audioLabel = document.createElement('span');
audioLabel.className = 'label';
audioLabel.textContent = 'OFF';
audioFab.appendChild(audioLabel);

document.body.appendChild(audioFab);

function audioBothPaused(){
  return (bg && bg.paused) && (bg2 && bg2.paused);
}
async function ensureAudioStarted(){ try { await startAudio(); } catch(_) {} }

function setFabState(isOn){
  audioLabel.textContent = isOn ? 'ON' : 'OFF';
  audioFab.classList.toggle('is-active', isOn);
  audioFab.setAttribute('aria-label', isOn ? 'Silenciar viento y goteo' : 'Activar viento y goteo');
}
function refreshFab(){ setFabState(!audioBothPaused()); }

audioFab.addEventListener('click', async (e)=>{
  e.stopPropagation();
  if (bg && bg2 && !bgStarted) {
    await ensureAudioStarted();
    refreshFab();
    return;
  }
  if (audioBothPaused()) {
    try { await bg.play(); } catch(_){}
    try { await bg2.play(); } catch(_){}
  } else {
    bg.pause(); bg2.pause();
  }
  refreshFab();
});

// Refleja cambios si el overlay u otro c√≥digo reproducen/pausan
bg && bg.addEventListener('play', refreshFab);
bg2 && bg2.addEventListener('play', refreshFab);
bg && bg.addEventListener('pause', refreshFab);
bg2 && bg2.addEventListener('pause', refreshFab);
refreshFab();


    function enableGate(on){ canAnswer=on; $pwd.disabled=$ok.disabled=!on; $ibox.classList.toggle('disabled',!on); $hint.textContent=on?'':'Listen First‚Ä¶'; if(on){
    try{
      const now = performance.now();
      const angry = (now < (window.__angryUntil||0)) || window.__angryMode;
      window.__nextHitAt = now + (angry ? 280 : (3000 + Math.random()*3000));
    }catch(_){}
$pwd.value='';} else {$pwd.blur();} }

    let typing=false,typeId=null,mouthId=null;
    function startMouth(){if(mouthId)clearInterval(mouthId);mouthId=setInterval(()=>{const t=performance.now()/150;const v=0.15+Math.abs(Math.sin(t))*0.85;setParam(MOUTH_PARAM,-30+v*60);},33);} 
    function stopMouth(){if(mouthId){clearInterval(mouthId);mouthId=null;}setParam(MOUTH_PARAM,0);} 
    function typeInto(el,text,done){if(typeId){clearInterval(typeId);typeId=null;}const str=String(text||'');typing=true;el.textContent='';startMouth();let i=0;if(!str.length){typing=false;stopMouth();return void(done&&done());}typeId=setInterval(()=>{el.textContent=str.slice(0,++i);if(i>=str.length){clearInterval(typeId);typeId=null;typing=false;stopMouth();done&&done();}},TYPE_DELAY);} 

    function writeAbove(text,done){const parts=String(text).split('\n');if(parts.length>1){$l2.textContent='';typeInto($l1,parts[0],()=>typeInto($l2,parts.slice(1).join(' '),()=>done&&done()));}else{$l2.textContent=$l1.textContent;typeInto($l1,parts[0],()=>done&&done());}}

    function showPhrases(){const pset=phases[currentPhase].phrases;const last=pset.length-1;const idx=Math.min(iphr,last);writeAbove(pset[idx],()=>{if(idx===last){enableGate(true);allowTap=false;}else{allowTap=true;}});} 
    function showErrorPhrases(){
      allowTap=false; enableGate(false);
      const phase = phases[currentPhase] || {};
      const list = (phase.error && phase.error.length) ? phase.error : DEFAULT_ERROR_LINES;
      let idx = Math.floor(Math.random() * list.length);
      if (list.length > 1 && idx === lastErrIndex) idx = (idx + 1) % list.length;
      lastErrIndex = idx;
      writeAbove(list[idx], ()=>{ enableGate(true); });
    }

    document.addEventListener('click',e=>{if(!ready||typing||!allowTap)return;const tag=(e.target.tagName||'').toLowerCase();if(tag==='input'||tag==='button'||(e.target.closest&&e.target.closest('.gate')))return;const psetLen=phases[currentPhase].phrases.length;if(iphr<psetLen-1){iphr++;showPhrases();}}, {passive:true});

    function tryEnter(){
      if(!canAnswer){$err.textContent='Primero escucha esta parte‚Ä¶';return;}
      const val=($pwd.value||'').trim().toLowerCase();if(!val)return;const phase=phases[currentPhase];
      if(val===phase.password){
        $err.textContent='';$pwd.value='';iphr=0;enableGate(false);allowTap=true; try{
  window.__angryMode = false;
  window.__angryUntil = 0;
  // Rearm next random hit for the next phase (3‚Äì6s)
  window.__nextHitAt = performance.now() + 3000 + Math.random()*3000;
}catch(_){}
        if(currentPhase<phases.length-1){ resetNeutral(); currentPhase++; showPhrases(); }
        else {
      triggerHappyFinal();
      // Fade inmediato y navegaci√≥n solo tras terminar la transici√≥n
      fb.classList.remove('prefade');
      fb.style.transition = `opacity ${FADE_OUT_DURATION_MS}ms`;
      void fb.offsetWidth; // forzar reflow para asegurar la transici√≥n
      fb.style.opacity = 1;
      const goNext = () => { window.location.href = 'next.html'; };
      const onEnd = (e) => { if (!e || e.propertyName === 'opacity') { fb.removeEventListener('transitionend', onEnd); goNext(); } };
      fb.addEventListener('transitionend', onEnd, { once: true });
      // Fallback por si 'transitionend' no dispara
      setTimeout(goNext, FADE_OUT_DURATION_MS + 250);
    }
      } else {
        iphr=0;triggerAngry();showErrorPhrases();$pwd.value='';$pwd.blur(); try{ window.__angryMode = true; const now = performance.now(); if (!window.__nextHitAt || window.__nextHitAt > now + 350) window.__nextHitAt = now + 120; }catch(_){}
      }
    }

    $ok.addEventListener('click',tryEnter);
    $pwd.addEventListener('keydown',e=>{if(e.key==='Enter')tryEnter();});
  })();
  </script>
  </div>
</body>
</html>
