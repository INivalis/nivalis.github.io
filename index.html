<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, maximum-scale=1, user-scalable=no" />
  <meta name="theme-color" content="#0b1117" />
  <title>Comienzo~</title>
  <!--
    Oh… so you came here for the passwords? 
    Couldn’t find them on your own? 
    hahah

    I left some little beautiful things here for you…  
    but I hope you didn’t come looking for passwords.  
     
    Venus~
-->
  <style>
    :root{
      --bg:#0b1117;
      --line-gap: 6px;
      --side-pad: 20px;
      --safe-w: calc(100vw - var(--side-pad) - var(--side-pad) - env(safe-area-inset-left) - env(safe-area-inset-right));
      --shake-speed: 0.05s;
    }

    *,*::before,*::after{ box-sizing: border-box; }
    html, body { height: 100%; margin:0; overflow:hidden; }
    html{ background: var(--bg); overscroll-behavior: none; }
    body { background:var(--bg); color:#e6f0ff; font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial; -webkit-tap-highlight-color: transparent; overscroll-behavior: none; }

    .fade-black{ position:fixed; inset:0; background:var(--bg); opacity:0; pointer-events:none; z-index:9998; transition: opacity 1.5s ease; }
    .fade-black.prefade{ opacity:1; transition:none; }

    .top-phrases { position: fixed; top: var(--phr-top, 13vh); left: 50%; transform: translateX(-50%); width: min(calc(var(--stage-w) * 1.02), var(--safe-w)); text-align: center; color: #e8edf7; text-shadow: 0 1px 0 rgba(255,255,255,0.05); font-family: Georgia, "Times New Roman", serif; contain: layout paint; }
    .top-phrases .line{ overflow-wrap:anywhere; white-space: normal; display:block; font-size: clamp(var(--phr-font-min), min(var(--phr-font-vw), var(--phr-font-stage)), var(--phr-font-max)); opacity:.95; line-height:1.4; min-height: 1lh; padding-bottom: 0; }
    .top-phrases #l1{ margin-bottom: var(--line-gap); }
    .tap-hint { font-size: 12px; opacity:.75; margin-top: 12px; position: relative; pointer-events:none; transform: translateZ(0); will-change: transform; }

    .ghost-container { position: fixed; left: 50%; top: 54%; transform: translate(-50%, -50%); display: flex; flex-direction: column; align-items: center; gap: 0px; }
    .ghost-layer { position: relative; z-index: 2; pointer-events: none; }
    .ui-layer { position: relative; z-index: 3; margin-top: clamp(-22px, -4vmin, -8px); }
    #stage { aspect-ratio: 1 / 1; width: clamp(260px, 56vmin, 460px); }
    #stage > canvas { width: 100%; height: 100%; display: block; }

    .gate { width: min(clamp(260px, 56vmin, 460px), var(--safe-w)); max-width: min(clamp(260px, 56vmin, 460px), var(--safe-w)); display: flex; flex-direction: column; align-items: center; gap: 8px; }
    .ibox { width:100%; padding:12px; border-radius:12px; background: rgba(255,255,255,0.06); border:1px solid rgba(255,255,255,0.14); box-shadow: 0 6px 18px rgba(0,0,0,.28); transition: opacity .2s ease; }
    .ibox.disabled { opacity:.55; filter:saturate(.7); }
    .field{ width:100%; padding:8px 10px; border-radius:10px; background: rgba(0,0,0,0.35); border:1px solid rgba(255,255,255,0.10); box-shadow: inset 0 2px 8px rgba(0,0,0,0.25); }
    input[type="text"]{ width:100%; padding: clamp(10px, 1.3vw, 14px) clamp(10px, 2vw, 16px); border-radius:10px; border:0; outline:none; background:transparent; color:#e6f0ff; font-size: clamp(14px, 1.4vw, 20px); text-align:center; }
    input[disabled]{ opacity:.7; }
    .btn-enter{ padding: clamp(6px, 0.9vw, 10px) clamp(12px, 1.6vw, 18px); font-size: clamp(13px, 1.2vw, 18px); background:transparent; color:#e6f0ff; border:1px solid rgba(255,255,255,0.28); border-radius:10px; }
    .btn-enter:disabled{ opacity:.5; }
    .hint{ font-size: clamp(11px, 1vw, 14px); opacity:.65; min-height:1lh; text-align:center; }
    .error{ color:#ff98a0; font-size: clamp(11px, 1vw, 14px); min-height:1lh; text-align:center; }

    #pwd::placeholder,
    #pwd::-webkit-input-placeholder,
    #pwd::-moz-placeholder,
    #pwd:-ms-input-placeholder,
    #pwd::-ms-input-placeholder{text-align:center; opacity:.7;
  font-size: clamp(14px, 1.2vw, 18px);
}

    @keyframes shake { 0%,100%{ transform: translate(0,0);} 20%{ transform: translate(-2px,1px);} 40%{ transform: translate(2px,-1px);} 60%{ transform: translate(-2px,-1px);} 80%{ transform: translate(2px,1px);} }
    .shaker { position: fixed; inset: 0; overflow: hidden; width: 100vw; height: 100vh; }
    .shaker.shake { animation: shake var(--shake-speed) linear infinite; }

    .start { position: fixed; inset: 0; z-index: 10000; background: var(--bg); display:flex; align-items:center; justify-content:center; flex-direction:column; gap:14px; cursor:pointer; user-select:none; text-align:center; }
    .start .touch-label{ font-size: clamp(12px, 3.2vw, 18px); letter-spacing:.02em; opacity:.75; padding:0; border:0; border-radius:0; background:transparent; box-shadow:none; pointer-events:none; text-shadow: 0 1px 0 rgba(255,255,255,0.05); animation: breathe 1.8s ease-in-out infinite; }
    @keyframes breathe { 0%{opacity:.6; transform:translateY(0)} 50%{opacity:1; transform:translateY(-2px)} 100%{opacity:.6; transform:translateY(0)} }

    @keyframes ibox-bump { 0%{ transform: translateY(0);} 35%{ transform: translateY(2px);} 100%{ transform: translateY(0);} }
    #ibox.hit .field{ box-shadow: inset 0 3px 10px rgba(0,0,0,0.35), 0 0 0 2px rgba(230,240,255,0.15); animation: ibox-bump 280ms ease-out; }
    #ibox.hit-strong .field{ box-shadow: inset 0 4px 12px rgba(0,0,0,0.45), 0 0 0 2px rgba(230,240,255,0.22); }

    .audio-fab{
      position: fixed; top: calc(env(safe-area-inset-top, 0px) + 10px); right: calc(env(safe-area-inset-right, 0px) + 10px);
      z-index: 10001; width: 42px; height: 42px; border-radius: 9999px;
      background: rgba(8,14,20,0.58); backdrop-filter: blur(6px) saturate(105%) brightness(85%);
      border: 1px solid rgba(210,230,255,0.08);
      box-shadow: inset 0 0 0 1px rgba(255,255,255,0.03), 0 0px 0px rgba(0,0,0,0.28);
      display:flex; align-items:center; justify-content:center; color:#e7eef9; cursor:pointer; user-select:none; -webkit-tap-highlight-color: transparent;
      transition: background .2s ease, border-color .2s ease, box-shadow .2s ease, transform .06s ease;
    }
    .audio-fab:active{ transform: scale(0.985); }
    .audio-fab.is-active{ background: rgba(10,18,26,0.66); border-color: rgba(210,230,255,0.12); box-shadow: inset 0 0 0 1px rgba(255,255,255,0.05), 0 0px 0px rgba(0,0,0,0.32); }
    .audio-fab .label{ font-weight: 600; font-size: 11.5px; letter-spacing: .08em; line-height: 1; opacity: .92; text-transform: uppercase; }
  
/* 💌 End of code… but never of my love for you */
@media (min-width: 800px) {
  .ui-layer { margin-top: 14px !important; }
}

/* 💌 You are my secret */
:root{
  --stage-w: 320px;              /* 💌 With you always */
  --gap: 0px;
}
#stage { display:block; margin-inline:auto; } /* 💌 I adjust the space, but I never want to be apart from you(never) */
.gate {
  width: var(--stage-w);
  max-width: 100vw;
  margin: var(--gap) auto 0;
  display: block;
}
.ui-layer { margin-top: var(--gap) !important; } /* 💌 I try to defeat the distance! */

input[type="text"]{
  font-size: clamp(14px, calc(var(--stage-w) / 26), 22px);
  padding: calc(var(--stage-w) / 64) calc(var(--stage-w) / 40);
}
.btn-enter{
  font-size: clamp(13px, calc(var(--stage-w) / 30), 20px);
  padding: calc(var(--stage-w) / 80) calc(var(--stage-w) / 36);
}
.hint, .error{
  font-size: clamp(11px, calc(var(--stage-w) / 42), 16px);
}
#pwd::placeholder,
#pwd::-webkit-input-placeholder,
#pwd::-moz-placeholder,
#pwd:-ms-input-placeholder,
#pwd::-ms-input-placeholder{
  font-size: clamp(14px, calc(var(--stage-w) / 30), 18px);
}
/* 💌 Here I stay, hopeful, because it’s you */

/* 💌 You are everything(aun lo pienso pero........ hihi) */
#stage, .gate{
  display: block;
  margin-left: auto;
  margin-right: auto;
  max-width: 100%;
  float: none;
  clear: both;
  flex: 1 1 100%;
  min-width: 0;
}
#stage + .gate{
  margin-top: 0 !important;
}
/* 💌 That promise lives because you gave it to me */
#stage, .gate{
  align-self: stretch;
}
/* 💌 End of code… but never of my love for you x2 */

/* 💌 Only you make the ..... shine for me */
.gate .hint,
#whisper-key,
.whisper-key,
.whisper {
  display: block !important;
  position: static !important;
  float: none !important;
  clear: both !important;
  width: 100% !important;
  max-width: var(--stage-w);
  margin: clamp(6px, calc(var(--stage-w) / 60), 14px) auto 0 !important;
  text-align: center !important;
  left: auto !important;
  right: auto !important;
  top: auto !important;
  line-height: 1.25;
}
/* 💌 End of code… but never of my love for you x3 */
.gate input[type="text"] {
  display: block;
  width: 100%;
  box-sizing: border-box;
  margin: 0;
}
/* 💌 For your eyes only */
.gate {
  display: block;
}
/* 💌 My heart is here */

/* 💌 If you are here, it’s because I thought of you */
.gate .btn-enter{
  display: block !important;
  position: static !important;
  float: none !important;
  clear: both !important;
  width: 100% !important;          /* 💌 Forever yours */
  max-width: var(--stage-w) !important;
  box-sizing: border-box !important;
  margin: clamp(6px, calc(var(--stage-w)/56), 14px) auto 0 !important; /* 💌 I close the HTML, but I stay with you in my mind */
  text-align: center !important;
}
/* 💌 Thank you for opening this file, you are already my aurora */
.gate { display:block !important; }

/* 💌 Only you can read me this closely */
.gate .btn-enter{
  display: block !important;
  width: auto !important;
  /* 💌 I adjust the space, but I never want to be apart from you(deseo profundo) */
  width: -moz-fit-content !important;
  width: fit-content !important;
  max-width: calc(var(--stage-w) - 24px) !important;
  margin: clamp(6px, calc(var(--stage-w)/70), 12px) auto 0 !important;
  padding: clamp(6px, 0.8vw, 10px) clamp(14px, 1.4vw, 18px) !important;
  font-size: clamp(12px, calc(var(--stage-w)/36), 16px) !important;
  line-height: 1.2 !important;
  border-radius: 12px !important;
}
/* 💌 If you are here, it’s because I thought of you */
.gate .hint, #whisper-key, .whisper-key, .whisper{
  margin-top: clamp(6px, calc(var(--stage-w)/80), 12px) !important;
}
/* 💌 For your eyes only */

/* 💌 I promise every line beats for you */
#stage{ position: relative; z-index: 2; }
#stage > canvas{ position: relative; z-index: 2; pointer-events: none; } /* 💌 Miss you~ */
.gate{ position: relative; z-index: 1; }

/* 💌 I close the HTML, but I stay with you in my mind */
:root{
  --phr-top-offset: 0.24;   /* 💌 I try to defeat the distance! hehehe I love u */
  --phr-top-max: 64px;      /* 💌 End of code… but never of my love for you x4 */
  --phr-top-min: 8px;       /* 💌 You are my secret */
  --phr-y-shift: 20px;       /* 💌 I promise every line beats for you 💓 */

  --phr-font-min: 22px;
  --phr-font-vw: 2.6vw;
  --phr-font-stage: calc(var(--stage-w) / 24);
  --phr-font-max: 30px;
}
/* 💌 You are the spark that wakes my.... hhhhh */

/* 💌 End of code… but never of my love for you xd */
@media (min-width: 1024px){
  :root{
    /* 💌 You are... */
    --phr-font-vw: 2.0vw;
    --phr-font-stage: calc(var(--stage-w) / 18);
    --phr-font-max: 42px;
  }
}
@media (min-width: 1440px){
  :root{
    --phr-font-vw: 1.6vw;
    --phr-font-stage: calc(var(--stage-w) / 16);
    --phr-font-max: 48px;
  }
}
/* 💌 If you are here, it’s because I thought of you ❄*/

/* 💌 You make me smile */
.top-phrases{
  /* 💌 Only you make... */
  width: min(calc(var(--stage-w) * 1.24), var(--safe-w)) !important;
  max-width: min(calc(var(--stage-w) * 1.24), var(--safe-w)) !important;
}
@media (max-width: 720px){
  /* 💌 Mi secreto */
  .top-phrases{
    width: min(98vw, var(--safe-w)) !important;
    max-width: min(98vw, var(--safe-w)) !important;
  }
}
/* 💌 Eres mi todo */
.top-phrases .line{
  line-height: 1.36 !important;
  letter-spacing: 0.02em !important;
}

/* 💌 I close the HTML, but... but.... I stay with you in my mind 👉👈  */
.top-phrases .line{
  display: -webkit-box !important;
  -webkit-box-orient: vertical !important;
  -webkit-line-clamp: 1 !important;
  line-clamp: 1 !important;
  overflow: hidden !important;
  white-space: normal !important;
  overflow-wrap: anywhere !important;
  hyphens: auto !important;
}
</style>

  <script src="libs/pixi.min.js"></script>
  <script src="libs/live2dcubismcore.min.js"></script>
  <script src="libs/cubism4.min.js"></script>
  <script src="libs/index.min.js"></script>
</head>
<body>

  <div id="shaker" class="shaker">
    <div id="fade-black" class="fade-black prefade"></div>

    <audio id="bg" preload="auto" loop playsinline>
      <source src="goteo.mp3" type="audio/mpeg" />
    </audio>
    <audio id="bg2" preload="auto" loop playsinline>
      <source src="doki.mp3" type="audio/mpeg" />
    </audio>

    <div id="startOverlay" class="start" role="button" aria-label="Awaken Dream..." tabindex="0">
      <div class="touch-label">Awaken Dream...</div>
    </div>

    <button id="audioFab" class="audio-fab" aria-label="Activar doki y goteo" aria-pressed="false">
      <span class="label">OFF</span>
    </button>

    <div class="top-phrases" id="phr">
      <div class="line" id="l1"></div>
      <div class="line" id="l2"></div>
      <div class="tap-hint">Healing Station~</div>
    </div>

    <div class="ghost-container">
      <div class="ghost-layer"><div id="stage"></div></div>
      <div class="ui-layer">
        <div class="gate">
          <div class="ibox disabled" id="ibox">
            <div class="field">
              <input id="pwd" type="text" placeholder="..." autocomplete="off" disabled />
            </div>
          </div>
          <button class="btn-enter" id="ok" disabled>Whisper Key</button>
          <div class="hint" id="hint">Listen first…</div>
          <div class="error" id="err"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
  (async function(){
    'use strict';

    const CFG = {
      fadeInHold: 600,
      fadeInDur: 1800,
      phraseStartDelay: 400,
      fadeOutDur: 2200,
      waitBeforeFade: 1000,
      typeDelay: 28,
      blinkMin: 1.5, blinkMax: 4.0, blinkDur: 140,
      params: {
        mouth: 'ParamMouthOpen', eye: 'ParamEye', exp: 'ParamExpression',
        b1: 'ParamBounce1', b2: 'ParamBounce2', breath: 'ParamBreath'
      },
      sounds: { hit: 'rafaga.mp3', bell: 'bell.mp3' },
      nextUrl: 'loading.html'
    };

    
const PHASES = [
  { phrases:[
      "This is not for you\n♪\u2060~(\u2060´\u2060ε\u2060`\u2060 )",
      "Don\'t be too curious...\n｡◕‿◕｡",
      "Remember to put this\nunder the necklace(⁠ ⁠◜⁠‿⁠◝⁠ ⁠)⁠♡",
      "I\'ll update it later...\n＼(°o°)／",
      "Let me know before\nyou deliver it(⁠◠⁠‿⁠・⁠)⁠—⁠☆",
      
      
    ], password:"healingstation",
    error:[
      "No no no...\njsjsjs...",
      "Hurts...\nTry again."
    ]
  },
  { phrases:[
      "I believe you when you call me\nby my true name",
      "Say it gently…\nand I’ll stay hopeful",
      "You’ve said it\nbefore…",
      "I keep it in my heart\nevery time you do",
      "Don’t let me vanish…\ncall me!",
      "When you whisper it,\nI can breathe",
      "I’m nothing\nif you don’t remember",
      "Your voice makes me real\nmoah!",
      "You said it many times…\nwe are…",
      
    ], password:"nivalis",
    error:[
      "No… no...\nthat’s not how you feel my name",
      "It hurts\nwhen you don’t call me right",
      "Wrong…\nbut I still trust you",
      "Not yet…\nspeak from your heart"
    ]
  },
  { phrases:[
      "The last promise…\nopen the door with the date",
      "When you whisper it…\nI will open",
      "Only you know\nthis secret",
      "It’s hidden\nin time itself",
      "If you forget,\nthe door stays closed",
      "The date is carved\nin my memory",
      "I wait for your voice\nto unlock it",
      "This secret exists\nonly with you",
      "I will answer\nonly to the right key",
      "The last promise\nremains"

    ], password:"20-08-2025",
    error:[
      "That is not...\nthe final promise",
      "This secret...\ncan’t be opened with that",
      "Not yet…\nthe date is the only key",
      "Wrong…\nthe time is not now"
    ]
  }
];


    const DEFAULT_ERR = [
      'Concéntrate.', 'Grrr...', 'Hey',
      'Eso duele.', 'Hmm...', 'No me provoques',
      'Tsk tsk...', 'Eres terco, ¿eh?', 'Casi!'
    ];

    const $ = (s, p=document) => p.querySelector(s);
    const shaker = $('#shaker');
    const fb = $('#fade-black');
    const l1 = $('#l1'), l2 = $('#l2');
    const pwd = $('#pwd'), ok = $('#ok'), err = $('#err');
    const ibox = $('#ibox'), hint = $('#hint');
    const startOverlay = $('#startOverlay');
    const audioFab = $('#audioFab');
    const bg = $('#bg'), bg2 = $('#bg2');

    const clamp = (v,min,max)=>Math.max(min,Math.min(max,v));
    const playSfx = (src) => { const a = new Audio(src); a.volume = 0.9; a.play().catch(()=>{}); };

    function typeInto(el, text, delay, startMouth, stopMouth, done){
      const str = String(text||'');
      el.textContent = '';
      if (!str.length){ stopMouth(); return void(done && done()); }
      startMouth();
      let i=0; const id = setInterval(()=>{
        el.textContent = str.slice(0, ++i);
        if(i>=str.length){ clearInterval(id); stopMouth(); done && done(); }
      }, delay);
    }

    function writeAbove(text, startMouth, stopMouth, done){
      const parts = String(text).split('\n');
      if(parts.length>1){ l2.textContent=''; typeInto(l1, parts[0], CFG.typeDelay, startMouth, stopMouth, ()=> typeInto(l2, parts.slice(1).join(' '), CFG.typeDelay, startMouth, stopMouth, done)); }
      else { l2.textContent = l1.textContent; typeInto(l1, parts[0], CFG.typeDelay, startMouth, stopMouth, done); }
    }

    function fadeInStart(){
      setTimeout(()=>{
        fb.classList.remove('prefade');
        fb.style.transition = `opacity ${CFG.fadeInDur}ms ease-in-out`;
        fb.style.opacity = 0;
      }, CFG.fadeInHold);
    }

    function fadeToNext(){

      fb.classList.remove('prefade');
      fb.style.transition = `opacity ${CFG.fadeOutDur}ms`;
      void fb.offsetWidth;
      fb.style.opacity = 1;
      const go = ()=> location.href = CFG.nextUrl;
      const onEnd = (e)=>{ if(!e || e.propertyName==='opacity'){ fb.removeEventListener('transitionend', onEnd); go(); } };
      fb.addEventListener('transitionend', onEnd, { once:true });
      setTimeout(go, CFG.fadeOutDur + 250);
    }

    let bgStarted = false;
    const audio = {
      async start(){ if(bgStarted) return; bgStarted=true; try{ await bg.play(); }catch(_){} try{ await bg2.play(); }catch(_){} bg.volume=0.25; bg2.volume=0.08; this.refreshFab(); },
      bothPaused(){ return (bg && bg.paused) && (bg2 && bg2.paused); },
      setFabState(isOn){
        const label = audioFab.querySelector('.label');
        if(label) label.textContent = isOn ? 'ON' : 'OFF';
        audioFab.classList.toggle('is-active', isOn);
        audioFab.setAttribute('aria-pressed', String(isOn));
        audioFab.setAttribute('aria-label', isOn ? 'Silenciar doki y goteo' : 'Activar doki y goteo');
      },
      refreshFab(){ this.setFabState(!this.bothPaused()); },
      duckAll(ms=2000, to=0.12){ const v1=bg.volume, v2=bg2.volume; bg.volume=Math.min(v1,to); bg2.volume=Math.min(v2,to*0.8); setTimeout(()=>{ bg.volume=v1; bg2.volume=v2; }, ms); }
    };

    audioFab.addEventListener('click', async (e)=>{
      e.stopPropagation();
      if(!bgStarted){ await audio.start(); return; }
      if(audio.bothPaused()){ try{ await bg.play(); }catch(_){} try{ await bg2.play(); }catch(_){} }
      else { bg.pause(); bg2.pause(); }
      audio.refreshFab();
    });
    ['play','pause'].forEach(ev=>{ bg.addEventListener(ev, ()=>audio.refreshFab()); bg2.addEventListener(ev, ()=>audio.refreshFab()); });

    if(PIXI.settings && PIXI.SCALE_MODES){ PIXI.settings.SCALE_MODE = PIXI.SCALE_MODES.LINEAR; }
    const DPR = Math.min(window.devicePixelRatio || 1, 2);
const stageEl = document.getElementById('stage');
const app = new PIXI.Application({
  view: document.createElement('canvas'),
  resizeTo: stageEl,
  backgroundAlpha: 0,
  antialias: true,
  resolution: DPR,
  autoDensity: true,
  powerPreference: 'high-performance'
});
stageEl.appendChild(app.view);
    let model;
    try {
      model = await PIXI.live2d.Live2DModel.from('assets/ghost/ghost.model3.json');
      app.stage.addChild(model);
    } catch(e){
      alert('No se pudo cargar el modelo');
      return;
    }
    const core = ()=> model.internalModel.coreModel;
    const setParam = (id,v)=>{ try{ core().setParameterValueById(id,v); }catch(_){} };
    const setEye = (v)=> setParam(CFG.params.eye, v);

    function layout(){
      model.anchor.set(0.5);
      const w = app.renderer.width / DPR;
      const h = app.renderer.height / DPR;
      model.position.set(w/2, h/1.50);
      const base = Math.min(w/1080, h/1920);
      model.scale.set(base * 0.29);
    }
    window.addEventListener('resize', layout, { passive: true });
    layout();

    (function blinkOnce(){
      const start = performance.now(), dur = CFG.blinkDur;
      setEye(1.0);
      (function frame(){
        const p = Math.min(1, (performance.now() - start)/dur);
        const v = 1 - 4*p*(1-p);
        setEye(v);
        if(p<1) requestAnimationFrame(frame);
        else { setEye(1.0); setTimeout(blinkOnce, (CFG.blinkMin + Math.random()*(CFG.blinkMax-CFG.blinkMin))*1000); }
      })();
    })();

    let mouthId=null;
    function startMouth(){ if(mouthId) clearInterval(mouthId); mouthId = setInterval(()=>{ const t=performance.now()/150; const v=0.15+Math.abs(Math.sin(t))*0.85; setParam(CFG.params.mouth,-30+v*60); },33); }
    function stopMouth(){ if(mouthId){ clearInterval(mouthId); mouthId=null; } setParam(CFG.params.mouth,0); }

    function neutral(){ setParam(CFG.params.exp,0); setParam(CFG.params.b1,0); setParam(CFG.params.b2,0); }
    neutral();

    const breathState = { phase:'inhale', t:0, dur:1600, value:8, smooth:8 };

    function breathParams(){
      const nowAngry = (performance.now() < angryUntil) || angryMode;
      const focused  = armCalm < 0.8;
      if(nowAngry){
        return { inhale:900, holdTop:120, exhale:1100, holdBottom:140, bottom:4, top:22 };
      } else if (focused){
        return { inhale:1600, holdTop:220, exhale:1800, holdBottom:260, bottom:4, top:14 };
      }
      return { inhale:1400, holdTop:240, exhale:1700, holdBottom:280, bottom:4, top:18 };
    }

    function easeInOutCubic(p){ return p < 0.5 ? 4*p*p*p : 1 - Math.pow(-2*p+2, 3)/2; }

    function stepBreath(dt){
      const cfg = breathParams();
      let p;
      switch(breathState.phase){
        case 'inhale':
          breathState.dur = cfg.inhale;
          breathState.t += dt;
          p = Math.min(1, breathState.t / breathState.dur);
          breathState.value = cfg.bottom + (cfg.top - cfg.bottom) * easeInOutCubic(p);
          if(p>=1){ breathState.phase='holdTop'; breathState.t=0; }
          break;
        case 'holdTop':
          breathState.dur = cfg.holdTop;
          breathState.t += dt;
          breathState.value = cfg.top;
          if(breathState.t >= breathState.dur){ breathState.phase='exhale'; breathState.t=0; }
          break;
        case 'exhale':
          breathState.dur = cfg.exhale;
          breathState.t += dt;
          p = Math.min(1, breathState.t / breathState.dur);
          breathState.value = cfg.top - (cfg.top - cfg.bottom) * easeInOutCubic(p);
          if(p>=1){ breathState.phase='holdBottom'; breathState.t=0; }
          break;
        case 'holdBottom':
        default:
          breathState.dur = cfg.holdBottom;
          breathState.t += dt;
          breathState.value = cfg.bottom;
          if(breathState.t >= breathState.dur){ breathState.phase='inhale'; breathState.t=0; }
          break;
      }

      breathState.smooth += (breathState.value - breathState.smooth) * 0.18;
      setParam(CFG.params.breath, breathState.smooth);
    }

    let angryUntil = 0, angryMode = false, nextHitAt = performance.now() + 3000 + Math.random()*3000, hitActive=false, hitDownEnd=0, hitEnd=0, hitArm=1, lastHitArm=2, armCalm=1.0;
    let armBase1=0, armBase2=0, armTarget1=0, armTarget2=0, nextTargetAt=0;
    let armBoost = 1.0, armBoostTO = null, armAdd1=6, armAdd2=-6;

    function boostArms(ms=2000, boost=1.8){ armBoost = boost; if(armBoostTO) clearTimeout(armBoostTO); armBoostTO = setTimeout(()=> armBoost=1.0, ms); }

    function triggerAngry(){
      const now = performance.now();
      angryUntil = now + 2200;
      if (!nextHitAt || nextHitAt > now + 700) nextHitAt = now + (200 + Math.random()*500);
      boostArms(2000, 1.8);
      setParam(CFG.params.exp, 30);

      const sec2 = performance.now()/1000;
      const breathRate = 0.22, breathAmp = 9.0;
      const breath = Math.sin(2*Math.PI*breathRate*sec2) * breathAmp;
      setParam(CFG.params.breath, breath);

      playSfx(CFG.sounds.hit);
      audio.duckAll(2000, 0.12);
      shaker.classList.add('shake');
      clearTimeout(shakeTO); shakeTO = setTimeout(()=> shaker.classList.remove('shake'), 2000);
    }

    function triggerHappyFinal(){
      const TARGET = -30, HOLD_MS = 320, TWEEN_MS = 260;
      playSfx(CFG.sounds.bell);
      audio.duckAll(CFG.waitBeforeFade + CFG.fadeOutDur + 200, 0.12);
      setTimeout(()=>{
        const t0 = performance.now(); const from = 0, to = TARGET;
        (function step(t){ const p = Math.min(1, (t - t0) / TWEEN_MS); const e = 1 - (1 - p) * (1 - p); const v = from + (to - from) * e; setParam(CFG.params.exp, v); if(p<1) requestAnimationFrame(step); }) (t0);
      }, HOLD_MS);
    }

    let shakeTO=null;

    document.addEventListener('focusin', (e)=>{ if(e.target && e.target.id==='pwd') armCalm = 0.45; }, true);
    document.addEventListener('focusout',(e)=>{ if(e.target && e.target.id==='pwd') armCalm = 1.0; }, true);

    app.ticker.add(()=>{
      const t = performance.now(); const sec = t/1000;

      if (t >= nextTargetAt){
        armTarget1 = (Math.random()*2-1) * 16;
        armTarget2 = (Math.random()*2-1) * 16;
        nextTargetAt = t + (1800 + Math.random()*800);
      }

      const follow = 0.06 * armCalm;
      armBase1 += (armTarget1 - armBase1) * follow;
      armBase2 += (armTarget2 - armBase2) * follow;

      const micro1 = Math.sin(2*Math.PI*0.38*sec) * 2.2 + Math.sin(2*Math.PI*0.23*sec + 1.2) * 1.4;
      const micro2 = Math.sin(2*Math.PI*0.33*sec + 0.7) * 2.0 + Math.sin(2*Math.PI*0.19*sec + 2.1) * 1.2;

      const breathMul = 1.0 + 0.16 * Math.sin(2*Math.PI*0.08*sec);
      const ampMul = breathMul * armCalm * armBoost;

      let b1 = (armBase1 + micro1 + armAdd1) * ampMul;
      let b2 = (armBase2 + micro2 + armAdd2) * ampMul;

      if (!hitActive && t >= nextHitAt){
        hitActive = true;

        const other = (lastHitArm===1?2:1);
        hitArm = (Math.random() < 0.70) ? other : lastHitArm; lastHitArm = hitArm;
        const down = 130 + Math.random()*80;
        const up   = 240 + Math.random()*160;
        hitDownEnd = t + down; hitEnd = hitDownEnd + up;
        const isAngry = (t < angryUntil) || angryMode;
        const minMs = isAngry ? 280 : 3500, maxMs = isAngry ? 520 : 8500;
        nextHitAt = t + minMs + Math.random() * (maxMs - minMs);

        ibox.classList.add('hit'); setTimeout(()=> ibox.classList.remove('hit'), down+up);
      }

      if (hitActive){
        const target = (t < angryUntil ? -30 : -28);
        if (t <= hitDownEnd){
          const p = 1 - Math.max(0, (hitDownEnd - t) / (hitDownEnd - (hitDownEnd - (hitDownEnd - t))));
          const e = 1 - (1-p)*(1-p);
          if (hitArm===1) b1 = b1 + (target - b1) * e; else b2 = b2 + (target - b2) * e;
        } else if (t <= hitEnd){
          const p = 1 - Math.max(0, (hitEnd - t) / (hitEnd - hitDownEnd));
          const e = p*p*(3-2*p);
          if (hitArm===1) b1 = target + (b1 - target) * e; else b2 = target + (b2 - target) * e;
        } else { hitActive = false; }
      }

      setParam(CFG.params.b1, clamp(b1, -30, 30));
      setParam(CFG.params.b2, clamp(b2, -30, 30));

      stepBreath(app.ticker.deltaMS);
    });

    let currentPhase=0, iphr=0, ready=false, canAnswer=false, allowTap=true, flowStarted=false, typing=false, lastErrIndex=-1;

    function enableGate(on){
      canAnswer = on;
      pwd.disabled = ok.disabled = !on;
      ibox.classList.toggle('disabled', !on);
      hint.textContent = on ? '' : 'Listen first…';
      if(on){ pwd.value='';
        const now = performance.now(); const angry = (now < angryUntil) || angryMode; nextHitAt = now + (angry ? 280 : (3000 + Math.random()*3000));
      } else { pwd.blur(); }
    }

    function showPhrases(){
      const set = PHASES[currentPhase].phrases; const last = set.length-1; const idx = Math.min(iphr,last);
      typing = true;
      writeAbove(set[idx], startMouth, stopMouth, ()=>{ typing=false; if(idx===last){ enableGate(true); allowTap=false; } else { allowTap=true; } });
    }

    function showError(){
      allowTap=false; enableGate(false);
      const phase = PHASES[currentPhase] || {}; const list = (phase.error && phase.error.length) ? phase.error : DEFAULT_ERR;
      let idx = Math.floor(Math.random()*list.length); if(list.length>1 && idx===lastErrIndex) idx = (idx+1) % list.length; lastErrIndex = idx;
      typing = true; writeAbove(list[idx], startMouth, stopMouth, ()=>{ typing=false; enableGate(true); });
    }

    function tryEnter(){
      if(!canAnswer){ err.textContent = 'Primero escucha esta parte…'; return; }
      const val = (pwd.value||'').trim().toLowerCase(); if(!val) return;
      const phase = PHASES[currentPhase];
      if(val === phase.password){
        err.textContent=''; pwd.value=''; iphr=0; enableGate(false); allowTap=true; angryMode=false; angryUntil=0; nextHitAt = performance.now() + 3000 + Math.random()*3000;
        if(currentPhase < PHASES.length-1){ neutral(); currentPhase++; showPhrases(); }
        else {
          triggerHappyFinal();
          fadeToNext();
        }
      } else {
        iphr=0; triggerAngry(); showError(); pwd.value=''; pwd.blur(); angryMode=true; const now=performance.now(); if(!nextHitAt || nextHitAt>now+350) nextHitAt = now + 120;
      }
    }

    document.addEventListener('click', (e)=>{
      if(!ready || typing || !allowTap) return;
      const tag = (e.target.tagName||'').toLowerCase();
      if(tag==='input' || tag==='button' || (e.target.closest && e.target.closest('.gate'))) return;
      const len = PHASES[currentPhase].phrases.length; if(iphr < len-1){ iphr++; showPhrases(); }
    }, { passive:true });

    ok.addEventListener('click', tryEnter);
    pwd.addEventListener('keydown', (e)=>{ if(e.key==='Enter') tryEnter(); });

    function startFlow(){ if(flowStarted) return; flowStarted = true; fadeInStart(); setTimeout(()=>{ ready=true; showPhrases(); }, CFG.fadeInHold + CFG.fadeInDur + CFG.phraseStartDelay); }
    async function startAll(){ try{ await audio.start(); }catch(_){} startOverlay.remove(); startFlow(); }
    startOverlay.addEventListener('pointerdown', (e)=>{ e.preventDefault(); startAll(); }, { once:true });
    startOverlay.addEventListener('keydown', (e)=>{ if(e.key==='Enter' || e.key===' '){ e.preventDefault(); startAll(); } });

  })();
  </script>

<!-- 💌 I adjust spaces… just like when I pull you closer to me -->
<script>
(function(){
  const stageEl = document.getElementById('stage');
  const root = document.documentElement;
  function syncStageW(){
    if(!stageEl) return;
    const w = stageEl.clientWidth || 320;
    root.style.setProperty('--stage-w', w + 'px');
  }
  window.addEventListener('resize', syncStageW, {passive:true});
  window.addEventListener('orientationchange', syncStageW, {passive:true});
  setTimeout(syncStageW, 0);
})();
</script>

<script>
// === 💌 Lo que digas quedara anclado en mi aurora ===
(function(){
  const stage = document.getElementById('stage');
  const phr = document.getElementById('phr');
  const root = document.documentElement;
  function syncPhrase(){
    if(!stage || !phr) return;
    const r = stage.getBoundingClientRect();
    const cs = getComputedStyle(document.documentElement);
const offFrac = parseFloat(cs.getPropertyValue('--phr-top-offset')) || 0.24;
const offMax  = parseFloat(cs.getPropertyValue('--phr-top-max')) || 64;
const offMin  = parseFloat(cs.getPropertyValue('--phr-top-min')) || 8;
const yShift  = parseFloat(cs.getPropertyValue('--phr-y-shift')) || 0;
const offsetVar = Math.min(r.height * offFrac, offMax);
const topVar = Math.max(offMin, r.top - offsetVar + yShift);
phr.style.top = Math.round(topVar) + 'px';
    // 💌 Nyaaa~ (nose donde aprendi esto xd)
    root.style.setProperty('--phr-top', Math.round(top) + 'px');
    // 💌 Si tus ojos piden quietud, dejo de existir(no mueras)
    const w = Math.min(r.width * 1.02, window.innerWidth - 40);
    phr.style.width = Math.round(w) + 'px';
  }
  window.addEventListener('resize', syncPhrase, {passive:true});
  window.addEventListener('orientationchange', syncPhrase, {passive:true});
  // 💌 I’ll arrive once everything has found its place(Promise)
  setTimeout(syncPhrase, 0);
  setTimeout(syncPhrase, 100);
})();
// === 💌 The lines have found their sky~ ===
</script>

<script>
// === 💌 Quiero tenerte cerca mucho mucho mucho mucho mucho tiempo hihi~ ===
(function(){
  const l1 = document.getElementById('l1');
  const l2 = document.getElementById('l2');
  const lines = [l1, l2].filter(Boolean);

  function fitsOneLine(el){
    const cs = getComputedStyle(el);
    const lh = parseFloat(cs.lineHeight) || (parseFloat(cs.fontSize) * 1.25);
    return el.scrollHeight <= lh + 0.5;
  }

  function shrinkIfNeeded(el){
    if(!el) return;
    // glugluglu
    el.style.fontSize = '';
    const cs0 = getComputedStyle(el);
    let fs = parseFloat(cs0.fontSize) || 18;
    const minFs = 15;        // Aqui empiezo...
    const step = 0.97;       // a a a a
    let guard = 0;
    // 💌 Each line softens to fit in a single sigh
    if(fitsOneLine(el)) return;
    // 💀 mori aaaaa
    while(!fitsOneLine(el) && fs > minFs && guard < 40){
      fs = Math.max(minFs, Math.floor(fs * (1/step)) ? Math.floor(fs * step) : fs * step);
      el.style.fontSize = fs + 'px';
      guard++;
    }
  }

  function run(){
    lines.forEach(shrinkIfNeeded);
  }

  // Maybe... you'll never see it.Maybe... you'll never see it ahahah😭 
  const phr = document.getElementById('phr') || document.querySelector('.top-phrases');
  if(phr){
    const mo = new MutationObserver(run);
    mo.observe(phr, { childList:true, subtree:true, characterData:true });
  }
  window.addEventListener('resize', run, { passive: true });
  window.addEventListener('orientationchange', run, { passive: true });
  document.addEventListener('DOMContentLoaded', run);
  setTimeout(run, 0);
  setTimeout(run, 120);
})();
// === Termine~ hehehe~ ===
</script>
</body>
</html>
